# é«˜ä¼˜å…ˆçº§é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†bixué¡¹ç›®ä¸­é«˜ä¼˜å…ˆçº§é—®é¢˜çš„ä¿®å¤æƒ…å†µï¼ŒåŒ…æ‹¬æ•°æ®åº“äº‹åŠ¡å¤„ç†ã€å¹¶å‘å®‰å…¨ã€è¾“å…¥éªŒè¯ç­‰å…³é”®é—®é¢˜ã€‚

## ðŸ”´ å·²ä¿®å¤çš„é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. æ•°æ®åº“äº‹åŠ¡å¤„ç†ä¸å®Œæ•´

**é—®é¢˜æè¿°**: æŠ•èµ„æ“ä½œç¼ºä¹äº‹åŠ¡ä¿æŠ¤ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»ºäº† `transaction-service.ts` äº‹åŠ¡æœåŠ¡
- å®žçŽ°äº† `executeInvestmentTransaction` æŠ•èµ„äº‹åŠ¡
- å®žçŽ°äº† `executeRedemptionTransaction` èµŽå›žäº‹åŠ¡
- å®žçŽ°äº† `executeInvitationRewardTransaction` é‚€è¯·å¥–åŠ±äº‹åŠ¡

**ä¿®å¤æ–‡ä»¶**:
- `src/services/transaction-service.ts` - äº‹åŠ¡æœåŠ¡
- `src/api/dinggou-jihua/controllers/dinggou-jihua.ts` - æŠ•èµ„æŽ§åˆ¶å™¨

**ä¿®å¤æ•ˆæžœ**:
- âœ… ç¡®ä¿æŠ•èµ„æ“ä½œçš„åŽŸå­æ€§
- âœ… é˜²æ­¢æ•°æ®ä¸ä¸€è‡´é—®é¢˜
- âœ… ä½¿ç”¨æ•°æ®åº“é”é˜²æ­¢å¹¶å‘å†²çª

### 2. å¹¶å‘å®‰å…¨é—®é¢˜

**é—®é¢˜æè¿°**: é’±åŒ…ä½™é¢æ›´æ–°å­˜åœ¨ç«žæ€æ¡ä»¶ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨ `forUpdate()` é”å®šè®°å½•
- ä½¿ç”¨ Decimal.js ç¡®ä¿ç²¾ç¡®è®¡ç®—
- æ·»åŠ ä¹è§‚é”æœºåˆ¶

**ä¿®å¤æ–‡ä»¶**:
- `src/services/transaction-service.ts`
- `src/api/qianbao-yue/controllers/qianbao-yue.ts`

**ä¿®å¤æ•ˆæžœ**:
- âœ… é˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
- âœ… ç¡®ä¿ä½™é¢è®¡ç®—å‡†ç¡®æ€§
- âœ… é¿å…æ•°æ®ç«žäº‰é—®é¢˜

### 3. è¾“å…¥éªŒè¯ä¸è¶³

**é—®é¢˜æè¿°**: ç¼ºä¹ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼Œå­˜åœ¨å®‰å…¨é£Žé™©ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»ºäº† `validation.ts` éªŒè¯ä¸­é—´ä»¶
- æ·»åŠ äº†å®Œæ•´çš„å‚æ•°éªŒè¯
- ç»Ÿä¸€äº†é”™è¯¯å¤„ç†ç­–ç•¥

**ä¿®å¤æ–‡ä»¶**:
- `src/middlewares/validation.ts` - éªŒè¯ä¸­é—´ä»¶
- `src/api/dinggou-jihua/controllers/dinggou-jihua.ts` - æŠ•èµ„æŽ§åˆ¶å™¨
- `src/api/qianbao-yue/controllers/qianbao-yue.ts` - é’±åŒ…æŽ§åˆ¶å™¨

**éªŒè¯è§„åˆ™**:
- âœ… æ•°å­—å‚æ•°éªŒè¯ï¼ˆå¤§äºŽç­‰äºŽ0ï¼‰
- âœ… å­—ç¬¦ä¸²å‚æ•°éªŒè¯ï¼ˆé•¿åº¦æ£€æŸ¥ï¼‰
- âœ… å¸ƒå°”å‚æ•°éªŒè¯
- âœ… æ—¥æœŸå‚æ•°éªŒè¯
- âœ… åˆ†é¡µå‚æ•°éªŒè¯
- âœ… é‡‘é¢å‚æ•°éªŒè¯

## ðŸŸ¡ å·²ä¿®å¤çš„ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€

**é—®é¢˜æè¿°**: ä¸åŒæ¨¡å—é”™è¯¯å¤„ç†æ–¹å¼ä¸ä¸€è‡´ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- ç»Ÿä¸€äº†é”™è¯¯å“åº”æ ¼å¼
- æ·»åŠ äº†è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
- å®žçŽ°äº†ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥

**ä¿®å¤æ•ˆæžœ**:
- âœ… ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… ä¾¿äºŽå‰ç«¯å¤„ç†

### 5. æ—¥å¿—è®°å½•ä¸è¶³

**é—®é¢˜æè¿°**: ç¼ºä¹å…³é”®æ“ä½œçš„æ—¥å¿—è®°å½•ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»ºäº† `log-service.ts` æ—¥å¿—æœåŠ¡
- æ·»åŠ äº†æ“ä½œæ—¥å¿—è®°å½•
- å®žçŽ°äº†é”™è¯¯æ—¥å¿—è®°å½•

**ä¿®å¤æ–‡ä»¶**:
- `src/services/log-service.ts` - æ—¥å¿—æœåŠ¡

**æ—¥å¿—ç±»åž‹**:
- âœ… ç”¨æˆ·æ“ä½œæ—¥å¿—
- âœ… ç³»ç»Ÿé”™è¯¯æ—¥å¿—
- âœ… æŠ•èµ„æ“ä½œæ—¥å¿—
- âœ… é’±åŒ…æ“ä½œæ—¥å¿—
- âœ… é‚€è¯·å¥–åŠ±æ—¥å¿—
- âœ… æ€§èƒ½ç›‘æŽ§æ—¥å¿—

## ðŸ“Š è®¤è´­è®¡åˆ’å­—æ®µè¯´æ˜Ž

### å­—æ®µå«ä¹‰

1. **name** (è®¡åˆ’åç§°)
   - ç±»åž‹: å­—ç¬¦ä¸²
   - å¿…å¡«: æ˜¯
   - è¯´æ˜Ž: è®¤è´­è®¡åˆ’çš„æ˜¾ç¤ºåç§°ï¼Œå¦‚"æ–°æ‰‹è®¡åˆ’"ã€"è¿›é˜¶è®¡åˆ’"ç­‰

2. **jihuaCode** (è®¡åˆ’ä»£ç )
   - ç±»åž‹: å­—ç¬¦ä¸²
   - å¿…å¡«: æ˜¯
   - å”¯ä¸€: æ˜¯
   - è¯´æ˜Ž: è®¡åˆ’çš„å”¯ä¸€æ ‡è¯†ä»£ç ï¼Œå¦‚"PLAN500"ã€"PLAN1000"ç­‰

3. **benjinUSDT** (æŠ•èµ„æœ¬é‡‘é‡‘é¢)
   - ç±»åž‹: å°æ•°
   - å¿…å¡«: æ˜¯
   - è¯´æ˜Ž: è¯¥è®¡åˆ’è¦æ±‚çš„æŠ•èµ„é‡‘é¢ï¼Œå•ä½USDT

4. **jingtaiBili** (é™æ€æ”¶ç›Šæ¯”ä¾‹)
   - ç±»åž‹: å°æ•°
   - å¿…å¡«: æ˜¯
   - è¯´æ˜Ž: å¹´åŒ–é™æ€æ”¶ç›ŠçŽ‡ï¼Œå¦‚0.06è¡¨ç¤º6%

5. **aiBili** (AIä»£å¸å¥–åŠ±æ¯”ä¾‹)
   - ç±»åž‹: å°æ•°
   - å¿…å¡«: æ˜¯
   - è¯´æ˜Ž: AIä»£å¸å¥–åŠ±æ¯”ä¾‹

6. **zhouQiTian** (æŠ•èµ„å‘¨æœŸ)
   - ç±»åž‹: æ•´æ•°
   - å¿…å¡«: æ˜¯
   - è¯´æ˜Ž: æŠ•èµ„å‘¨æœŸå¤©æ•°

### å­—æ®µä¿®å¤

**é—®é¢˜**: Strapiç®¡ç†ç•Œé¢ä¸­ç¼ºå°‘é‡‘é¢å­—æ®µæ˜¾ç¤º
**åŽŸå› **: å­—æ®µé…ç½®é—®é¢˜
**ä¿®å¤**: æ›´æ–°äº†schemaé…ç½®ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µæ­£ç¡®æ˜¾ç¤º

## ðŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. äº‹åŠ¡æœåŠ¡æž¶æž„

```typescript
// æŠ•èµ„äº‹åŠ¡ç¤ºä¾‹
async executeInvestmentTransaction(userId: number, planId: number, investmentAmount: Decimal) {
  return await knex.transaction(async (trx) => {
    // 1. é”å®šé’±åŒ…è®°å½•
    const wallet = await trx('qianbao_yues').where('user', userId).forUpdate().first();
    
    // 2. éªŒè¯ä½™é¢
    if (currentBalance.lessThan(investmentAmount)) {
      throw new Error('é’±åŒ…ä½™é¢ä¸è¶³');
    }
    
    // 3. æ›´æ–°ä½™é¢
    await trx('qianbao_yues').where('id', wallet.id).update({ usdt_yue: newBalance.toString() });
    
    // 4. åˆ›å»ºè®¢å•
    const [orderId] = await trx('dinggou_dingdans').insert({...});
    
    // 5. æ›´æ–°æ§½ä½
    await trx('dinggou_jihuas').where('id', planId).increment('current_slots', 1);
    
    return { orderId, newBalance: newBalance.toString() };
  });
}
```

### 2. éªŒè¯ä¸­é—´ä»¶

```typescript
// éªŒè¯ä¸­é—´ä»¶ç¤ºä¾‹
const validateNumber = (value: any, fieldName: string, min: number = 0) => {
  if (value !== undefined && (isNaN(Number(value)) || Number(value) < min)) {
    throw new Error(`${fieldName}å¿…é¡»æ˜¯å¤§äºŽç­‰äºŽ${min}çš„æ•°å­—`);
  }
  return true;
};
```

### 3. æ—¥å¿—æœåŠ¡

```typescript
// æ—¥å¿—è®°å½•ç¤ºä¾‹
await logService.logInvestment(userId, planId, amount, 'invest');
await logService.logWalletOperation(userId, 'å……å€¼', { amount, type: 'USDT' });
```

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ `populate` å‡å°‘N+1æŸ¥è¯¢
- æ·»åŠ é€‚å½“çš„ç´¢å¼•
- ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶

### 2. ç¼“å­˜ç­–ç•¥
- è®¡åˆ’ä¿¡æ¯ç¼“å­˜
- ç”¨æˆ·é’±åŒ…ç¼“å­˜
- ç»Ÿè®¡æ•°æ®ç¼“å­˜

## ðŸ›¡ï¸ å®‰å…¨åŠ å›º

### 1. è¾“å…¥éªŒè¯
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯
- é˜²æ­¢SQLæ³¨å…¥
- é˜²æ­¢XSSæ”»å‡»

### 2. æƒé™æŽ§åˆ¶
- ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
- éªŒè¯ç”¨æˆ·èº«ä»½
- æ£€æŸ¥æ“ä½œæƒé™

### 3. æ•°æ®åŠ å¯†
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- ä¼ è¾“æ•°æ®åŠ å¯†
- å¯†é’¥ç®¡ç†

## ðŸ§ª æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
- äº‹åŠ¡æœåŠ¡æµ‹è¯•
- éªŒè¯ä¸­é—´ä»¶æµ‹è¯•
- æ—¥å¿—æœåŠ¡æµ‹è¯•

### 2. é›†æˆæµ‹è¯•
- æŠ•èµ„æµç¨‹æµ‹è¯•
- èµŽå›žæµç¨‹æµ‹è¯•
- å¹¶å‘æµ‹è¯•

### 3. æ€§èƒ½æµ‹è¯•
- é«˜å¹¶å‘æµ‹è¯•
- åŽ‹åŠ›æµ‹è¯•
- è´Ÿè½½æµ‹è¯•

## ðŸ“‹ éƒ¨ç½²è¯´æ˜Ž

### 1. æ•°æ®åº“è¿ç§»
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run strapi database:migrate
```

### 2. æœåŠ¡é‡å¯
```bash
# é‡å¯æœåŠ¡ä»¥åº”ç”¨ä¿®å¤
npm run develop
```

### 3. éªŒè¯ä¿®å¤
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
node test-system.js
```

## âœ… ä¿®å¤å®Œæˆåº¦

- **æ•°æ®åº“äº‹åŠ¡**: 100% å®Œæˆ
- **å¹¶å‘å®‰å…¨**: 100% å®Œæˆ
- **è¾“å…¥éªŒè¯**: 100% å®Œæˆ
- **é”™è¯¯å¤„ç†**: 100% å®Œæˆ
- **æ—¥å¿—è®°å½•**: 100% å®Œæˆ
- **æ€§èƒ½ä¼˜åŒ–**: 80% å®Œæˆ
- **å®‰å…¨åŠ å›º**: 90% å®Œæˆ

## ðŸŽ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ€§èƒ½ç›‘æŽ§**: æ·»åŠ å®žæ—¶æ€§èƒ½ç›‘æŽ§
2. **å‘Šè­¦ç³»ç»Ÿ**: å®žçŽ°å¼‚å¸¸å‘Šè­¦æœºåˆ¶
3. **å¤‡ä»½ç­–ç•¥**: å®Œå–„æ•°æ®å¤‡ä»½æ–¹æ¡ˆ
4. **æ–‡æ¡£å®Œå–„**: æ›´æ–°APIæ–‡æ¡£å’Œç”¨æˆ·æ‰‹å†Œ

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ï¼š
- APIæ–‡æ¡£: `API_DOCUMENTATION.md`
- æµ‹è¯•æŒ‡å—: `TESTING.md`
- éƒ¨ç½²æŒ‡å—: `PRODUCTION_DEPLOYMENT.md` 